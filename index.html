
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>tushman.io</title>
  <meta name="author" content="Jonathan Tushman">

  
  <meta name="description" content="Pragmatic Behavior Driven Development Description Love your test suite again (or for the first time). Have you ever met a developer who loves their &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jtushman.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="tushman.io" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/lib/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-41121782-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">tushman.io</a></h1>
  
    <h2>The musings of an insecure technologist</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jtushman.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/09/15/pycon-proposal-pragmatic-behavior-driven-development/">PyCon Proposal - Pragmatic Behavior Driven Development</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-09-15T10:27:00-04:00" pubdate data-updated="true">Sep 15<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3>Pragmatic Behavior Driven Development</h3>

<h4>Description</h4>

<p>Love your test suite again (or for the first time).</p>

<p>Have you ever met a developer who loves their test suite for their web app.  There is subtle air of confidence surrounding them.  They stand a bit taller; walk with a bit of a swagger.</p>

<p>This talk will put you on that path, by showing an approach of Behavior Driven Development using lettuce and selenium</p>

<h4>Detailed Abstract</h4>

<p>Behavior Driven Development (BDD) is a development process based on Test-Driven Development – but makes a significant modification.  With TDD – the main goal was to achieve test-coverage (what percentage of your code is covered by tests).  With BDD – the driving question – “What percentage of my user stories are covered?”  The main test-unit is the user story.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Story: Returns go to stock  
</span><span class='line'>
</span><span class='line'>In order to keep track of stock 
</span><span class='line'>As a store owner 
</span><span class='line'>I want to add items back to stock when they're returned  
</span><span class='line'>
</span><span class='line'>Scenario 1: Refunded items should be returned to stock 
</span><span class='line'>Given a customer previously bought a black sweater from me 
</span><span class='line'>And I currently have three black sweaters left in stock 
</span><span class='line'>When he returns the sweater for a refund 
</span><span class='line'>Then I should have four black sweaters in stock</span></code></pre></td></tr></table></div></figure>


<p>With an application that leverages BDD, will have a set of feature files, and a feature file will have a collection of stories written is a specific format Given, When, Then.</p>

<p>Python has some tooling that helps turn this format into a fully automated test framework.  We use <em>lettuce</em> to process feature files, and <em>selenium</em> to drive the web browser.</p>

<h4>Outline:</h4>

<h3>Pragmatic Behavior Driven Development</h3>

<h4>Description</h4>

<p>Love your test suite again (or for the first time).</p>

<p>Have you ever met a developer who loves their test suite for their web app?  There is subtle air of confidence surrounding them.  They stand a bit taller; walk with a bit of a swagger.</p>

<p>This talk will put you on that path by showing an approach of Behavior Driven Development using lettuce and selenium.</p>

<h4>Detailed Abstract</h4>

<p>Behavior Driven Development (BDD) is a development process based on Test-Driven Development – but makes a significant modification.  With TDD – the main goal was to achieve test coverage (what percentage of your code is covered by tests).  With BDD the driving question is “What percentage of my user stories are covered?”  The main test unit is the user story.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Story: Returns go to stock  
</span><span class='line'>
</span><span class='line'>In order to keep track of stock 
</span><span class='line'>As a store owner 
</span><span class='line'>I want to add items back to stock when they're returned  
</span><span class='line'>
</span><span class='line'>Scenario 1: Refunded items should be returned to stock 
</span><span class='line'>Given a customer previously bought a black sweater from me 
</span><span class='line'>And I currently have three black sweaters left in stock 
</span><span class='line'>When he returns the sweater for a refund 
</span><span class='line'>Then I should have four black sweaters in stock</span></code></pre></td></tr></table></div></figure>


<p>With an application that leverages BDD, we will have a set of feature files, and a feature file will have a collection of stories written is a specific format: Given, When, Then.</p>

<p>Python has some tooling that helps turn this format into a fully automated test framework.  We use <em>lettuce</em> to process feature files and <em>selenium</em> to drive the web browser.</p>

<h4>Outline:</h4>

<ol>
<li>Intro (5 mins)

<ol>
<li>Who am I?</li>
<li>20 years of development and testing, and what I have seen over time</li>
<li>Explain why BDD is an important evolution</li>
</ol>
</li>
<li>Writing your first Test  (5 mins)

<ol>
<li>Explain the Gherkin Format (Given, When, Then)</li>
<li>Write your first test – watch it fail</li>
</ol>
</li>
<li>Given / When / Then  (15 mins)

<ol>
<li><em>Given</em>: Using Factories to set up your data</li>
<li><em>When</em>: Trigger Events</li>
<li><em>Then</em>: Writing &ldquo;Deterministic&rdquo; assertions</li>
</ol>
</li>
<li>Setting up your testing environment (10 mins)

<ol>
<li>The <code>terrain.py</code> file</li>
<li>Work around javascript timing issues with a selenium adaptor</li>
</ol>
</li>
<li>Other tools to flesh out your test suite (5 mins)

<ol>
<li>Coverage</li>
<li>Flake8</li>
<li>Travis (or CI)</li>
<li>Unit Test Frameworks (such as nose)</li>
</ol>
</li>
</ol>


<h4>Additional Notes:</h4>

<ul>
<li>My parallelized version of lettuce is open sourced <a href="https://github.com/jtushman/lettuce">here</a></li>
<li>I have other open-source libraries, can find them <a href="https://github.com/jtushman">here</a></li>
<li>This is my first time speaking at PyCon.  I have spoken at Boston Python.  My slides for that talk are <a href="http://jtushman.github.io/blog/2014/07/22/boston-python-%7C-monarch-and-bouncer-notes/">here</a></li>
<li>I sometimes write about Python.  My blog is <a href="http://jtushman.github.io/">here</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/08/15/describing-descriptors-descriptively/">Describing Descriptors Descriptively</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-08-15T15:33:00-04:00" pubdate data-updated="true">Aug 15<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>Is it ironic that the documentation for descriptors is not very descriptive</p></blockquote>

<p>Descriptors are one of my favorite Python features &mdash; but it took me too long to discover them.  The documentation and tutorials that I found were too complex for me.  So I would like to offer a different approach, a <em>code first</em> approach</p>

<h3>Agenda</h3>

<ul>
<li>Definition</li>
<li>A Problem that Descriptors Can Solve</li>
<li>CODE!!  Solution to the Problem</li>
<li>Reflection on the Code, and explanation on how we used Descriptors</li>
</ul>


<h3>Definition</h3>

<blockquote><p>In general, a descriptor is an object attribute with “binding behavior”, one whose attribute access has been overridden by methods in the descriptor protocol. Those methods are __get__(), __set__(), and __delete__(). If any of those methods are defined for an object, it is said to be a descriptor.</p></blockquote>

<p>Read that and stash it in your brain for a few minutes.  By the end of this article you&rsquo;ll grok this</p>

<h3>A Problem that Descriptors Can Solve</h3>

<p>Imagine that you need to consume a 3rd party API that returns json documents.  Often solutions to this problem look like this &hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">USER_API_URI</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">111</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">to_json</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;results&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">&#39;name&#39;</span><span class="p">])</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="s">&#39;barf&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I dislike this solution, Its concise, but it breaks <a href="http://en.wikipedia.org/wiki/Separation_of_concerns">separation-of-concerns</a>.  The code consuming the API should not be concerned about the exact path and location of the data element in the json document.</p>

<h4>Proposed Solution with Descriptors:</h4>

<p>Our goal is to write code like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="n">UserAPI</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">street_address</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>CODE!!  Solution to the Problem</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># Hey guys this is a descriptor -- Woot!!        </span>
</span><span class='line'><span class="k">class</span> <span class="nc">Extractor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">_extract</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">json_blob</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">_extract</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="o">*</span><span class="n">keys</span><span class="p">):</span>
</span><span class='line'>        <span class="sd">&quot;&quot;&quot;</span>
</span><span class='line'><span class="sd">        digs into an dict or lists, if anything along the way is None, then simply return None</span>
</span><span class='line'><span class="sd">        &quot;&quot;&quot;</span>
</span><span class='line'>        <span class="n">end_of_chain</span> <span class="o">=</span> <span class="n">your_dict</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
</span><span class='line'>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_of_chain</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">end_of_chain</span><span class="p">:</span>
</span><span class='line'>                <span class="n">end_of_chain</span> <span class="o">=</span> <span class="n">end_of_chain</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span class='line'>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">end_of_chain</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
</span><span class='line'>                <span class="n">end_of_chain</span> <span class="o">=</span> <span class="n">end_of_chain</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span class='line'>            <span class="k">else</span><span class="p">:</span>
</span><span class='line'>                <span class="k">return</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="n">end_of_chain</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now look how elegant our code can look</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">JSONResponse</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">json_blob</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">json_blob</span> <span class="o">=</span> <span class="n">json_blob</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">JSONRepsonse</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">name</span> <span class="o">=</span> <span class="n">Extractor</span><span class="p">(</span><span class="s">&#39;result&#39;</span><span class="p">,</span><span class="s">&#39;username&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">street_address</span> <span class="o">=</span> <span class="n">Extractor</span><span class="p">(</span><span class="s">&#39;result&#39;</span><span class="p">,</span><span class="s">&#39;address&#39;</span><span class="p">,</span> <span class="s">&#39;street&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="n">status</span> <span class="o">=</span> <span class="n">Extractor</span><span class="p">(</span><span class="s">&#39;result&#39;</span><span class="p">,</span><span class="s">&#39;status&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">UserAPI</span><span class="p">(</span><span class="nb">object</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="nd">@class_method</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get_by_id</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
</span><span class='line'>        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">USER_GET_ENDPOINT</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">)</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">User</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">())</span>
</span></code></pre></td></tr></table></div></figure>


<p>And now are code is warm and fuzzy:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="n">UserAPI</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">street_address</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Reflection on the Code</h3>

<p>The real magic of descriptors happens with the signatures of __get__(), __set__(), and __delete__():</p>

<ul>
<li><code>object.__get__(self, instance, owner)</code></li>
<li><code>object.__set__(self, instance, value)</code></li>
<li><code>object.__delete__(self, instance)</code></li>
</ul>


<p>Each of these signatures contains a reference to <code>instance</code>, which is the instance of the <em>owner</em>&rsquo;s class.  So in our example:</p>

<p><em>instance</em> will be an instance of the User class
<em>owner</em> will be the User class
<em>self</em> is the instance of the Descriptor, which in our case holds the <code>path</code> attribute.</p>

<p>Let&rsquo;s take a look at our example where we made a descriptor <em>Extractor</em>.
&ndash; <code>user = UserAPI.get_by_id(111)</code></p>

<p>Here we get an instance of a User object, which has the json_blob stored on it from the GET request</p>

<ul>
<li><code>print(user.name)</code></li>
</ul>


<p>Now we call <code>name</code> on that object, which we defined: <code>name = Extractor('result','username')</code>.  At this point when we call <code>name</code> it is going to use the Extractor descriptor to extract the value from the json_blob.</p>

<p>The concern of extracting data from a json blob is nicely contained in our Descriptor  I think this is one of many great ways to use descriptors to DRY up your code.</p>

<p>Hope this is helpful!</p>

<h3>Additional Resources</h3>

<ul>
<li>Our man Raymond Hettinger&rsquo;s  (<a href="http://twitter.com/raymondh">@raymondh</a>) <a href="https://docs.python.org/2/howto/descriptor.html">Descriptor HowTo Guide</a></li>
<li>Chris Beaumont&rsquo;s: <a href="http://nbviewer.ipython.org/urls/gist.github.com/ChrisBeaumont/5758381/raw/descriptor_writeup.ipynb">Descriptors Demystified</a></li>
</ul>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/23/explaining-bouncer-and-method-decorators/">Explaining Bouncer and Method_decorators</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-23T15:42:00-04:00" pubdate data-updated="true">Jul 23<span>rd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Thank you Boston Python for the opportunity to present at <a href="http://www.meetup.com/bostonpython/events/179514872/">&ldquo;July Presentation Night: What I Built at Work&rdquo;</a>.</p>

<p>I would like to elaborate on one of the questions asked during the Q&amp;A after my presentation.  It was a question about <a href="https://github.com/jtushman/bouncer">bouncer</a>.</p>

<p>When I shared the following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">bouncer</span> <span class="kn">import</span> <span class="n">authorization_method</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">bouncer.constants</span> <span class="kn">import</span> <span class="n">READ</span><span class="p">,</span> <span class="n">EDIT</span><span class="p">,</span> <span class="n">MANAGE</span><span class="p">,</span> <span class="n">ALL</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@authorization_method</span>
</span><span class='line'><span class="k">def</span> <span class="nf">authorize</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">they</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">:</span>
</span><span class='line'>        <span class="n">they</span><span class="o">.</span><span class="n">can</span><span class="p">(</span><span class="n">MANAGE</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">they</span><span class="o">.</span><span class="n">can</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
</span><span class='line'>        <span class="n">they</span><span class="o">.</span><span class="n">cannot</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="s">&#39;TopSecretDocs&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">def</span> <span class="nf">if_author</span><span class="p">(</span><span class="n">article</span><span class="p">):</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">article</span><span class="o">.</span><span class="n">author</span> <span class="o">==</span> <span class="n">user</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">they</span><span class="o">.</span><span class="n">can</span><span class="p">(</span><span class="n">EDIT</span><span class="p">,</span> <span class="s">&#39;Article&#39;</span><span class="p">,</span> <span class="n">if_author</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Someone asked: what is <code>user</code> and <code>they</code>?  It was a really good question and deserved a better explanation.</p>

<p>The first thing to consider is <code>@authorization_method</code>  This is a <a href="http://legacy.python.org/dev/peps/pep-0318/">method decorator</a>,a really nice Python feature &mdash; particularly when you are writing framework code.</p>

<blockquote><p>A <code>method decorator</code> is a method that takes in a method as an argument and returns a mutated method. (pause to re-read that)</p></blockquote>

<p>Let&rsquo;s take a look at this specific implementation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># in bouncer/__init__.py</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_authorization_method</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">_authorization_method</span>
</span><span class='line'>
</span><span class='line'><span class="n">_authorization_method</span> <span class="o">=</span> <span class="bp">None</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">authorization_method</span><span class="p">(</span><span class="n">original_method</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;The method that will be injected into the authorization target to perform authorization&quot;&quot;&quot;</span>
</span><span class='line'>    <span class="k">global</span> <span class="n">_authorization_method</span>
</span><span class='line'>    <span class="n">_authorization_method</span> <span class="o">=</span> <span class="n">original_method</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">original_method</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>So in the instance of our authorization_method, we receive a function and store it in the global variable _authorization_method.  We can make of use of this function later in application&rsquo;s execution.</p>

<p>For example.  In my talk I showed the <code>can</code> method:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">jonathan</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;jonathan&#39;</span><span class="p">,</span><span class="n">admin</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'><span class="n">marc</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s">&#39;marc&#39;</span><span class="p">,</span><span class="n">admin</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">article</span> <span class="o">=</span> <span class="n">Article</span><span class="p">(</span><span class="n">author</span><span class="o">=</span><span class="n">jonathan</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">print</span> <span class="n">can</span><span class="p">(</span><span class="n">jonathan</span><span class="p">,</span> <span class="n">EDIT</span><span class="p">,</span> <span class="n">article</span><span class="p">)</span>   <span class="c"># True</span>
</span><span class='line'><span class="k">print</span> <span class="n">can</span><span class="p">(</span><span class="n">marc</span><span class="p">,</span> <span class="n">EDIT</span><span class="p">,</span> <span class="n">article</span><span class="p">)</span>       <span class="c"># False</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Can Marc view articles in general?</span>
</span><span class='line'><span class="k">print</span> <span class="n">can</span><span class="p">(</span><span class="n">marc</span><span class="p">,</span> <span class="n">VIEW</span><span class="p">,</span> <span class="n">Article</span><span class="p">)</span>       <span class="c"># True</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>can</code> is defined as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">def</span> <span class="nf">can</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">subject</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Checks if a given user has the ability to perform the action on a subject</span>
</span><span class='line'>
</span><span class='line'><span class="sd">    :param user: A user object</span>
</span><span class='line'><span class="sd">    :param action: an action string, typically &#39;read&#39;, &#39;edit&#39;, &#39;manage&#39;.  Use bouncer.constants for readability</span>
</span><span class='line'><span class="sd">    :param subject: the resource in question.  Either a Class or an instance of a class.  Pass the class if you</span>
</span><span class='line'><span class="sd">                    want to know if the user has general access to perform the action on that type of object.  Or</span>
</span><span class='line'><span class="sd">                    pass a specific object, if you want to know if the user has the ability to that specific instance</span>
</span><span class='line'>
</span><span class='line'><span class="sd">    :returns: Boolean</span>
</span><span class='line'><span class="sd">    &quot;&quot;&quot;</span>
</span><span class='line'>    <span class="n">ability</span> <span class="o">=</span> <span class="n">Ability</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">get_authorization_method</span><span class="p">())</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">ability</span><span class="o">.</span><span class="n">can</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">subject</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>When &ldquo;can&rdquo; is called, it builds an <code>Ability</code> using the logic in method we decorated (stored) with <code>@authorization_method</code></p>

<p>Having said that, let me explain what <code>they</code> and <code>they.can</code> is.</p>

<p><code>they</code> is a <code>RuleList</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># in bouncer/models.py</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">RuleList</span><span class="p">(</span><span class="nb">list</span><span class="p">):</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">item_description_or_rule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class='line'>        <span class="c"># Will check it a Rule or a description of a rule</span>
</span><span class='line'>        <span class="c"># construct a rule if necessary then append</span>
</span><span class='line'>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item_description_or_rule</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item_description_or_rule</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Rule</span><span class="p">):</span>
</span><span class='line'>            <span class="n">item</span> <span class="o">=</span> <span class="n">item_description_or_rule</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>            <span class="nb">super</span><span class="p">(</span><span class="n">RuleList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'>        <span class="k">else</span><span class="p">:</span>
</span><span class='line'>            <span class="c"># try to construct a rule</span>
</span><span class='line'>            <span class="n">item</span> <span class="o">=</span> <span class="n">Rule</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="o">*</span><span class="n">item_description_or_rule</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</span><span class='line'>            <span class="nb">super</span><span class="p">(</span><span class="n">RuleList</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c"># alias append</span>
</span><span class='line'>    <span class="c"># so you can do things like this:</span>
</span><span class='line'>    <span class="c">#     @authorization_method</span>
</span><span class='line'>    <span class="c"># def authorize(user, they):</span>
</span><span class='line'>    <span class="c">#</span>
</span><span class='line'>    <span class="c">#     if user.is_admin:</span>
</span><span class='line'>    <span class="c">#         # self.can_manage(ALL)</span>
</span><span class='line'>    <span class="c">#         they.can(MANAGE, ALL)</span>
</span><span class='line'>    <span class="c">#     else:</span>
</span><span class='line'>    <span class="c">#         they.can(READ, ALL)</span>
</span><span class='line'>    <span class="c">#</span>
</span><span class='line'>    <span class="c">#         def if_author(article):</span>
</span><span class='line'>    <span class="c">#             return article.author == user</span>
</span><span class='line'>    <span class="c">#</span>
</span><span class='line'>    <span class="c">#         they.can(EDIT, Article, if_author)</span>
</span><span class='line'>    <span class="n">can</span> <span class="o">=</span> <span class="n">append</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>RuleList</code> is a python <code>list</code> with two tweaks:</p>

<ol>
<li>override <code>append</code> to handle inputing of Rules or something I can construct into a rule</li>
<li>alias append <code>can = append</code> which allows us to have the desired syntax <code>they.can(READ, ALL)</code></li>
</ol>


<p>I am pretty pleased with this; I really like the they.can(READ, ALL) syntax.  Some may argue that it is not pythonic since I could be more explicit &mdash; but in this case I think ease of readability trumps style.</p>

<p>But if you don&rsquo;t agree, no worries you can use the following equivalent syntax:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="nd">@authorization_method</span>
</span><span class='line'><span class="k">def</span> <span class="nf">authorize</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">abilities</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">is_admin</span><span class="p">:</span>
</span><span class='line'>        <span class="n">abilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">MANAGE</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="n">abilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">READ</span><span class="p">,</span> <span class="n">ALL</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c"># See I am using a string here</span>
</span><span class='line'>        <span class="n">abilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">EDIT</span><span class="p">,</span> <span class="s">&#39;Article&#39;</span><span class="p">,</span> <span class="n">author</span><span class="o">=</span><span class="n">user</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Both work!</p>

<p>Hopefully this clarifies things.  Feel free to ping me with additional questions.</p>

<hr />

<h3>Addendum</h3>

<p>There has been a fair bit of discussion in my office about the grammatically correctness of <code>they</code>.  Uncannily, xkcd comes to the rescue once again:</p>

<p><img src="http://imgs.xkcd.com/comics/dinosaur_comics.png" alt="image" /></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/07/22/boston-python-%7C-monarch-and-bouncer-notes/">Boston Python | Monarch and Bouncer Notes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-22T17:44:00-04:00" pubdate data-updated="true">Jul 22<span>nd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The Boston Python group was nice enough to have me speak about things I built at work</p>

<p>I spoke about:</p>

<ul>
<li><a href="https://github.com/jtushman/monarch">Monarch</a> | Migration Framework</li>
<li><a href="https://github.com/jtushman/bouncer">Bouncer</a> | Declarative Authorization</li>
</ul>


<p>This was my presentation:</p>

<div class="blazon-iframe-wrapper" style="position: relative; padding-bottom: 58.59375%; padding-top: 40px;"><iframe src="http://presentboldly.com/tushman/monarch-and-bouncer/embed" style="position: absolute; left: 0; right: 0; bottom: 0; top: 0; width: 100%; height: 100%;" frameborder="0" allowfullscreen><a href="http://presentboldly.com/tushman/monarch-and-bouncer">View this presentation on Blazon</a></iframe></div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/05/02/module-properties/">Module Properties | the Proxy Pattern</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-05-02T16:58:00-04:00" pubdate data-updated="true">May 2<span>nd</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Have you ever tried to add a <code>@property</code> to a module?</p>

<p>I was working on a authentication_manager.  And I wanted to usage of the module to be like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">login_manager</span> <span class="kn">import</span> <span class="n">current_user</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">do_sometime_with_a_user</span><span class="p">():</span>
</span><span class='line'>    <span class="k">print</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'>    <span class="n">current_user</span><span class="o">.</span><span class="n">speak</span><span class="p">()</span>
</span><span class='line'>    <span class="n">current_user</span><span class="o">.</span><span class="n">say_hi</span><span class="p">(</span><span class="s">&#39;lauren&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p><code>current_user</code> is going to return the current User if it exists.  In other words it needs to call a function.</p>

<p>This would be pretty trivial if I would be okay with using parens all over the place</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">current_user</span><span class="p">()</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span><span class='line'><span class="c"># gross ----------^^</span>
</span><span class='line'><span class="n">current_user</span><span class="p">()</span><span class="o">.</span><span class="n">speak</span><span class="p">()</span>
</span><span class='line'><span class="c"># gross ----^^</span>
</span><span class='line'><span class="n">current_user</span><span class="p">()</span><span class="o">.</span><span class="n">say_hi</span><span class="p">(</span><span class="s">&#39;lauren&#39;</span><span class="p">)</span>
</span><span class='line'><span class="c"># gross ----^^</span>
</span></code></pre></td></tr></table></div></figure>


<p>But that makes me want to barf.  Luckily python gives us the tools to clean this up.  We are going to use the Proxy pattern to solve it.  At its simplest we can do something like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">Proxy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">local</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">local</span> <span class="o">=</span> <span class="n">local</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
</span><span class='line'>        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local</span><span class="p">(),</span> <span class="n">name</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># aliasing for better syntax        </span>
</span><span class='line'><span class="n">module_property</span> <span class="o">=</span> <span class="n">Proxy</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
</span><span class='line'>    <span class="sd">&quot;&quot;&quot;Contrived User Object&quot;&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</span><span class='line'>        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="s">&#39;billy&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">speak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Well hello there!&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">say_hi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">to_whom</span><span class="p">):</span>
</span><span class='line'>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Hi there {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">to_whom</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@module_property</span>
</span><span class='line'><span class="k">def</span> <span class="nf">current_user</span><span class="p">():</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">User</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this we have come close to achieving our goal:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">login_manager</span> <span class="kn">import</span> <span class="n">current_user</span><span class="p">,</span> <span class="n">User</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="k">print</span> <span class="n">current_user</span><span class="o">.</span><span class="n">name</span>
</span><span class='line'>    <span class="n">current_user</span><span class="o">.</span><span class="n">speak</span><span class="p">()</span>
</span><span class='line'>    <span class="n">current_user</span><span class="o">.</span><span class="n">say_hi</span><span class="p">(</span><span class="s">&#39;lauren&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This simple Proxy class that we defined.  Takes a function, stores in a local variable, and then when it is accessed it is executed with names and arguments passed through to it.  <code>__getattr__</code> is a pretty special feature of python.</p>

<p>The big gotcha with this is that current_user does not return a User object (like the built-in @property will return), it is going to return the Proxy object.  So without a little bit of additional care you might run into issues.</p>

<p>The werkzeug team has developed a fully featured Proxy within the werkzerg project.  If you are using werkzeug, you can find it: <code>from werkzeug.local import LocalProxy</code></p>

<p>Its takes the proxy pattern further by overwriting all of the python <code>object</code> methods such as __eq__, __le__, __str__ and so on, to use the proxied object as the underlying target.</p>

<p>If you are not using werkzeug I have created a mini library where you can get the extracted proxy code.  You can find it here: (<a href="http://github.com/jtushman/proxy_tools">http://github.com/jtushman/proxy_tools</a>)</p>

<p>Or install it like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pip install proxy_tools
</span></code></pre></td></tr></table></div></figure>


<p>And use it like so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="c"># your_module/__init__.py</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">proxy_tools</span> <span class="kn">import</span> <span class="n">module_property</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@module_property</span>
</span><span class='line'><span class="k">def</span> <span class="nf">current_user</span><span class="p">():</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">User</span><span class="o">.</span><span class="n">find_by_id</span><span class="p">(</span><span class="n">request</span><span class="p">[</span><span class="s">&#39;user_id&#39;</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Then elsewhere</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">your_module</span> <span class="kn">import</span> <span class="n">current_user</span>
</span><span class='line'><span class="k">print</span><span class="p">(</span><span class="n">current_user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now &mdash; I am sure there was a very good reason why the python-powers-that-be chose not add the <code>@property</code> syntax to modules.  But for the time being I have found it useful and elegant.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/24/parallelize-your-lettuce-tests-to-win-friends-and-influence-others/">Parallelize Your Lettuce Tests to Win Friends and Influence Others</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-24T15:23:00-05:00" pubdate data-updated="true">Jan 24<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><strong>tl;dr:</strong>  I forked the lettuce package to use multiprocessing, tests run more then 4x faster on my MBP</p>

<p>I am a fan of Gabriel Falcão&rsquo;s <a href="http://lettuce.it/">lettuce</a> Behavior-Driven Development (BDD) tool.  We have been using it on my team for 6+ months now.  Recently our test suite completion time has crossed the 10 minute line, which had a bunch of negative effects, as you can imagine:</p>

<ul>
<li>people writing less tests</li>
<li>people running the test suite less frequently</li>
<li>people spending more time watching a test suite run, then coding, …</li>
</ul>


<p>We all are using relatively modern MBP with 4 cores, and we might as well make the most of them.  Here is my fork of lettuce that allows you to take advantage of all of your cores:</p>

<p><a href="https://github.com/jtushman/lettuce">https://github.com/jtushman/lettuce</a></p>

<p>I have made two main modifications (You will find the lion share of my modifications in this <a href="https://github.com/jtushman/lettuce/blob/master/lettuce/__init__.py">file</a>):</p>

<ul>
<li>I created a ParallelRunner (I have left the main runner alone), which kicks off processes to pull the scenarios off a queue</li>
<li>After each run I store the run times of each test in a <code>.scenarios</code> file, so in subsequent runs I can sort them longest to shortest</li>
</ul>


<p>My test suite used to take 12 minutes, now its takes 2 minutes &mdash; REJOICE!</p>

<h2>Usage</h2>

<p><code>lettuce tests -p 4 -v 2</code></p>

<p><strong>-p:</strong> stands for parallel.  You can set it to how many processes you like, I find that the number of cores should be your default</p>

<p><strong>-v</strong> is the same verbosity parameter, but I recommend setting it to 2 when using parallelization, otherwise the steps will interlace and not make much sense</p>

<p>in your <code>terrain.py</code> file, there are two new callbacks:</p>

<p><code>@before.batch</code> and <code>@after.batch</code></p>

<p>which you should use to set up and tear down each process.  I use main to fire up flask, selenium and mongo.  Also note that I set a port_number attribute on world which you can use set up processes specific servers.  For example:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="nd">@before.batch</span>
</span><span class='line'><span class="k">def</span> <span class="nf">batch_setup</span><span class="p">():</span>
</span><span class='line'>    <span class="n">settings</span><span class="o">.</span><span class="n">MONGO_DATABASE_NAME</span> <span class="o">=</span> <span class="s">&#39;testing__{}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">world</span><span class="o">.</span><span class="n">port_number</span><span class="p">)</span>
</span><span class='line'>    <span class="n">mongoengine</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MONGO_DATABASE_NAME</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MONGO_HOST</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MONGO_PORT</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">username</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MONGO_USERNAME</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MONGO_PASSWORD</span><span class="p">)</span>
</span><span class='line'>    <span class="n">clear_database</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Caveats</h2>

<p>For this to work <strong>all of your tests need to be isolated</strong>, they can not depend on each other (which I think is best practice anyways).  This means in your tests you <strong>should not use</strong> world <strong>at all</strong>  Use <em>scenario</em> instead:</p>

<p>To do this, in your <code>terrain</code> file add the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">class</span> <span class="nc">ScenarioState</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span> <span class="k">pass</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@before.each_scenario</span>
</span><span class='line'><span class="k">def</span> <span class="nf">setup_senario</span><span class="p">(</span><span class="n">senario</span><span class="p">):</span>
</span><span class='line'>    <span class="n">world</span><span class="o">.</span><span class="n">scenario</span> <span class="o">=</span> <span class="n">ScenarioState</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">scenario</span><span class="p">():</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">world</span><span class="o">.</span><span class="n">scenario</span>
</span></code></pre></td></tr></table></div></figure>


<p>And I use this all the time in my steps to refer to state from previous steps</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="nd">@step</span><span class="p">(</span><span class="s">u&#39;Given a user exists with one account&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">given_a_user_exists</span><span class="p">(</span><span class="n">step</span><span class="p">):</span>
</span><span class='line'>    <span class="n">scenario</span><span class="o">.</span><span class="n">current_user</span> <span class="o">=</span> <span class="n">UserFactory</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'><span class="nd">@step</span><span class="p">(</span><span class="s">u&#39;And the user has a dog&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">def</span> <span class="nf">user_has_a_dog</span><span class="p">(</span><span class="n">step</span><span class="p">):</span>
</span><span class='line'>    <span class="n">scenario</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">dog</span> <span class="o">=</span> <span class="n">DogFactory</span><span class="o">.</span><span class="n">create</span><span class="p">()</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>Hope you guys find this useful!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2014/01/14/python-%7C-multiprocessing-and-interrupts/">Python | Multiprocessing and Interrupts</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-14T22:21:00-05:00" pubdate data-updated="true">Jan 14<span>th</span>, 2014</time>
        
      </p>
    
  </header>


  <div class="entry-content"><h3><strong>tl;dr:</strong> If handling interrupts is important, use a SyncManager (not multiprocessing.Manager) to handle shared state</h3>

<p>I just hit the learning curve pretty hard with python&rsquo;s <a href="http://docs.python.org/2/library/multiprocessing.html">multiprocessing</a> &mdash; but I came through it and wanted to share my learnings.</p>

<h2>Preliminary Thoughts</h2>

<p>The bulk of this post is going to be around using the multiprocess library, but a few preliminary thoughts:</p>

<h4>Multiprocessing and Threading is hard (especially in python):</h4>

<p>Its starts off all hunky-dory &mdash; but trust me, factor in time to hit the wall … hard.</p>

<h4>pstree is your friend.</h4>

<p>Stop what you are doing, and pick your favorite package manager and install <code>pstree</code>: (for me: <code>brew install pstree</code>)</p>

<p>Its super-useful for dealing with sub-processes, and see what is going on.</p>

<p>In particular <code>pstree -s &lt;string&gt;</code> which searches your branches containing processes that contain the string in the command line.  So much better than <code>ps</code></p>

<p>Output looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>➜  pstree -s python
</span><span class='line'>-+<span class="o">=</span> 00001 root /sbin/launchd
</span><span class='line'> <span class="se">\-</span>+<span class="o">=</span> 00221 jtushman /sbin/launchd
</span><span class='line'>   <span class="se">\-</span>+<span class="o">=</span> 00446 jtushman /Applications/iTerm.app/Contents/MacOS/iTerm -psn_0_188462
</span><span class='line'>     <span class="se">\-</span>+<span class="o">=</span> 07770 root login -fp jtushman
</span><span class='line'>       <span class="se">\-</span>+<span class="o">=</span> 07771 jtushman -zsh
</span><span class='line'>         <span class="se">\-</span>+<span class="o">=</span> 46662 jtushman python multi3.py
</span><span class='line'>           |--- 46663 jtushman python multi3.py
</span><span class='line'>           |--- 46664 jtushman python multi3.py
</span><span class='line'>           |--- 46665 jtushman python multi3.py
</span><span class='line'>           |--- 46666 jtushman python multi3.py
</span><span class='line'>           <span class="se">\-</span>-- 46667 jtushman python multi3.py
</span></code></pre></td></tr></table></div></figure>


<h4>Know your options</h4>

<p>There are more then one paralyzation framework / paradigms out there for python.  Make sure you pick the right one for you before you dive-in.  To name a few:</p>

<ul>
<li><a href="http://docs.python.org/2/library/threading.html">python threading</a></li>
<li><a href="http://www.gevent.org///">greenlets and gevent</a></li>
<li><a href="http://www.celeryproject.org/">celery</a></li>
</ul>


<p><strong>Important</strong>: Unless you are a ninja &mdash; do not mix paradigms.  For example if you are using the multiprocessing library &mdash; do not use threading.locals</p>

<h2>The Main Story</h2>

<h3>Axiom One:  All child processes get SIG-INT</h3>

<p><strong>Note:</strong> I will use SIG_INT, Keyboard Interrupt, and Ctr-C interchangeably</p>

<p>Consider the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Manager</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">process_number</span><span class="p">):</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;starting thread: &quot;</span><span class="p">,</span> <span class="n">process_number</span>
</span><span class='line'>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>            <span class="k">print</span> <span class="n">process_number</span>
</span><span class='line'>            <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Keyboard interrupt in process: &quot;</span><span class="p">,</span> <span class="n">process_number</span>
</span><span class='line'>    <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;cleaning up thread&quot;</span><span class="p">,</span> <span class="n">process_number</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span class='line'>        <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,))</span>
</span><span class='line'>        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'>        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
</span><span class='line'>            <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Keyboard interrupt in main&quot;</span>
</span><span class='line'>    <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Cleaning up Main&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>The abbreviated output you get is as follows:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>^C
</span><span class='line'>Keyboard interrupt in process:  3
</span><span class='line'>Keyboard interrupt in process:  0
</span><span class='line'>Keyboard interrupt in process:  2
</span><span class='line'>cleaning up thread 3
</span><span class='line'>cleaning up thread 0
</span><span class='line'>cleaning up thread 2
</span><span class='line'>Keyboard interrupt in process:  1
</span><span class='line'>cleaning up thread 1
</span><span class='line'>Keyboard interrupt in main
</span><span class='line'>Cleaning up Main
</span></code></pre></td></tr></table></div></figure>


<p>The main take aways are:</p>

<ul>
<li>Keyboard interrupt gets send to each sub process and main execution</li>
<li>the order in which the run is non-determanistic</li>
</ul>


<h3>Axiom Two:  Beware multiprocessing.Manager (time to share memory between processes)</h3>

<p>If it is possible in your stack to rely on a database, such as redis for keeping track of shared state &mdash; I recommend it.  But if you need a pure python solution read on:</p>

<p><a href="http://docs.python.org/2/library/multiprocessing.html#managers">multiprocessing.Manager</a> bill themselves as:</p>

<blockquote><p>Managers provide a way to create data which can be shared between different processes.  <strong>A manager object controls a server process</strong> which manages shared objects. Other processes can access the shared objects by using proxies.</p></blockquote>

<p>The key take away there is that the Manager actually kicks off a server process to manage state.  Its like it is firing up your own little (not battle tested) private database.  And if you Ctr-C your python process the manager will get the signal and shut it self down causing all sorts of weirdness.</p>

<p>Consider the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Manager</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">process_number</span><span class="p">,</span> <span class="n">shared_array</span><span class="p">):</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;starting thread: &quot;</span><span class="p">,</span> <span class="n">process_number</span>
</span><span class='line'>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>            <span class="n">shared_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_number</span><span class="p">)</span>
</span><span class='line'>            <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Keyboard interrupt in process: &quot;</span><span class="p">,</span> <span class="n">process_number</span>
</span><span class='line'>    <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;cleaning up thread&quot;</span><span class="p">,</span> <span class="n">process_number</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">manager</span> <span class="o">=</span> <span class="n">Manager</span><span class="p">()</span>
</span><span class='line'>    <span class="n">shared_array</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span class='line'>        <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">shared_array</span><span class="p">))</span>
</span><span class='line'>        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'>        <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
</span><span class='line'>            <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Keyboard interrupt in main&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">shared_array</span><span class="p">:</span>
</span><span class='line'>        <span class="c"># raises &quot;socket.error: [Errno 2] No such file or directory&quot;</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">item</span>
</span></code></pre></td></tr></table></div></figure>


<p>Try running that and interrupting it was a Ctr-C, you will get a weird error:</p>

<p>You will get a <code>socket.error: [Errno 2] No such file or directory</code> when trying to access the shared_array.  And thats because the Manager process has been interrupted.</p>

<p><strong>There is a solution!</strong></p>

<h3>Axiom Two:  Explicitly use multiprocessing.manangers.SyncManager to share state</h3>

<p>and use the signals library to have the SyncManager ignore the interrupt signal (SIG_INT)</p>

<p>Consider the following code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">multiprocessing.managers</span> <span class="kn">import</span> <span class="n">SyncManager</span>
</span><span class='line'><span class="kn">import</span> <span class="nn">signal</span>
</span><span class='line'><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
</span><span class='line'>
</span><span class='line'><span class="c"># initializer for SyncManager</span>
</span><span class='line'><span class="k">def</span> <span class="nf">mgr_init</span><span class="p">():</span>
</span><span class='line'>    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIG_IGN</span><span class="p">)</span>
</span><span class='line'>    <span class="k">print</span> <span class="s">&#39;initialized manager&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">process_number</span><span class="p">,</span> <span class="n">shared_array</span><span class="p">):</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;starting thread: &quot;</span><span class="p">,</span> <span class="n">process_number</span>
</span><span class='line'>        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</span><span class='line'>            <span class="n">shared_array</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_number</span><span class="p">)</span>
</span><span class='line'>            <span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</span><span class='line'>    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;Keyboard interrupt in process: &quot;</span><span class="p">,</span> <span class="n">process_number</span>
</span><span class='line'>    <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;cleaning up thread&quot;</span><span class="p">,</span> <span class="n">process_number</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c"># now using SyncManager vs a Manager</span>
</span><span class='line'>    <span class="n">manager</span> <span class="o">=</span> <span class="n">SyncManager</span><span class="p">()</span>
</span><span class='line'>    <span class="c"># explicitly starting the manager, and telling it to ignore the interrupt signal</span>
</span><span class='line'>    <span class="n">manager</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">mgr_init</span><span class="p">)</span>
</span><span class='line'>    <span class="k">try</span><span class="p">:</span>
</span><span class='line'>        <span class="n">shared_array</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">list</span><span class="p">()</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
</span><span class='line'>            <span class="n">p</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">shared_array</span><span class="p">))</span>
</span><span class='line'>            <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span><span class='line'>            <span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">try</span><span class="p">:</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">process</span> <span class="ow">in</span> <span class="n">processes</span><span class="p">:</span>
</span><span class='line'>                <span class="n">process</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
</span><span class='line'>        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
</span><span class='line'>            <span class="k">print</span> <span class="s">&quot;Keyboard interrupt in main&quot;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">shared_array</span><span class="p">:</span>
</span><span class='line'>            <span class="c"># we still have access to it!  Yay!</span>
</span><span class='line'>            <span class="k">print</span> <span class="n">item</span>
</span><span class='line'>    <span class="k">finally</span><span class="p">:</span>
</span><span class='line'>      <span class="c"># to be safe -- explicitly shutting down the manager</span>
</span><span class='line'>        <span class="n">manager</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Main take aways here are:</p>

<ul>
<li>Explicitly using and starting a SyncManager (instead of Manager)</li>
<li>on its initialization having it ignore the interrupt</li>
</ul>


<p>I will do a future post on gracefully shutting down child threads (once I figure that out ;&ndash;)</p>

<p>Thanks to @armsteady, who showed me the like on StackOverflow (<a href="http://stackoverflow.com/a/21106459/192791">link</a>)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/11/06/dict-digger/">Dict Digger</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-11-06T18:18:00-05:00" pubdate data-updated="true">Nov 6<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the age or SaaS, and working with 3rd part APIs developers often have to navigate a complex object (arrays of hashes of arrays or hashes) (I am looking at you Adwords API)</p>

<p>I wanted a nice way to avoid doing None checks and does this key exist over and over again.</p>

<p>So I made a (very) simple utility to help with it <a href="https://github.com/jtushman/dict_digger"><em>dict_digger</em></a></p>

<p>And works like this …</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pip install dict_digger
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">dict_digger</span>
</span><span class='line'>
</span><span class='line'><span class="n">h</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>         <span class="s">&#39;b&#39;</span><span class="p">:</span> <span class="s">&#39;tuna&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="s">&#39;c&#39;</span><span class="p">:</span> <span class="s">&#39;fish&#39;</span>
</span><span class='line'>     <span class="p">},</span>
</span><span class='line'>     <span class="s">&#39;b&#39;</span><span class="p">:</span> <span class="p">{}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">result</span> <span class="o">=</span> <span class="n">dict_digger</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span><span class="s">&#39;b&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">result</span>  <span class="c"># prints &#39;tuna&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">result</span> <span class="o">=</span> <span class="n">dict_digger</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;a&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">result</span> <span class="c"># prints None</span>
</span><span class='line'><span class="c"># Important!!  Does not through an error, just returns None</span>
</span><span class='line'>
</span><span class='line'><span class="c">#but if you like</span>
</span><span class='line'><span class="n">result</span> <span class="o">=</span> <span class="n">dict_digger</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="s">&#39;c&#39;</span><span class="p">,</span><span class="s">&#39;a&#39;</span><span class="p">,</span> <span class="n">fail</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</span><span class='line'><span class="c"># raises a KeyError</span>
</span><span class='line'>
</span><span class='line'><span class="c"># also support complex objects so ...</span>
</span><span class='line'>
</span><span class='line'><span class="nb">complex</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="s">&#39;a&#39;</span><span class="p">:</span> <span class="p">{</span>
</span><span class='line'>         <span class="p">[</span><span class="s">&#39;tuna&#39;</span><span class="p">,</span><span class="s">&#39;fish&#39;</span><span class="p">]</span>
</span><span class='line'>     <span class="p">},</span>
</span><span class='line'>     <span class="s">&#39;b&#39;</span><span class="p">:</span> <span class="p">{}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">result</span> <span class="o">=</span> <span class="n">dict_digger</span><span class="o">.</span><span class="n">dig</span><span class="p">(</span><span class="nb">complex</span><span class="p">,</span> <span class="s">&#39;a&#39;</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">result</span> <span class="c">#prints tuna</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Alternatively you do the following</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="k">try</span><span class="p">:</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="n">h</span><span class="p">[</span><span class="s">&#39;c&#39;</span><span class="p">][</span><span class="s">&#39;a&#39;</span><span class="p">]</span>
</span><span class='line'><span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
</span><span class='line'>    <span class="n">result</span> <span class="o">=</span> <span class="bp">None</span>
</span></code></pre></td></tr></table></div></figure>


<p>Find it on github <a href="https://github.com/jtushman/dict_digger">here</a></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/10/shuffling-team-seating/">Shuffling Team Seating</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-10T21:29:00-04:00" pubdate data-updated="true">Oct 10<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>I think it is good to shuffle the team around.  Helps with cross-pollination, and keeps the team area neat.  Here is the function that we use to randomize our team making sure that you do not sit next to someone you are already sitting next to.</p>

<p>Note:  Only works with teams greater than four.  Assign each space in your office an number, the run the following.  The first person in the outputted array goes in space 1, and so on.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="kn">import</span> <span class="nn">random</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">all_perms</span><span class="p">(</span><span class="n">elements</span><span class="p">):</span>
</span><span class='line'>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)</span> <span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
</span><span class='line'>        <span class="k">yield</span> <span class="n">elements</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">all_perms</span><span class="p">(</span><span class="n">elements</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
</span><span class='line'>            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">elements</span><span class="p">)):</span>
</span><span class='line'>                <span class="c">#nb elements[0:1] works in both string and list contexts</span>
</span><span class='line'>                <span class="k">yield</span> <span class="n">perm</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">elements</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">perm</span><span class="p">[</span><span class="n">i</span><span class="p">:]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">find_position</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="n">lizt</span><span class="p">):</span>
</span><span class='line'>    <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lizt</span><span class="p">)</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">new_neighbors</span><span class="p">(</span><span class="n">some_list</span><span class="p">):</span>
</span><span class='line'>    <span class="n">new_neighbor_list</span> <span class="o">=</span> <span class="n">some_list</span><span class="p">[:]</span>
</span><span class='line'>    <span class="n">list_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">some_list</span><span class="p">)</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">new_neighbor_list</span> <span class="ow">in</span> <span class="n">all_perms</span><span class="p">(</span><span class="n">some_list</span><span class="p">):</span>
</span><span class='line'>        <span class="k">print</span> <span class="n">new_neighbor_list</span>
</span><span class='line'>        <span class="n">too_many_neighbors</span> <span class="o">=</span> <span class="bp">False</span>
</span><span class='line'>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">team_member</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">new_neighbor_list</span><span class="p">):</span>
</span><span class='line'>            <span class="c">#find position in inital list</span>
</span><span class='line'>            <span class="n">position_in_original_list</span> <span class="o">=</span> <span class="n">find_position</span><span class="p">(</span><span class="n">team_member</span><span class="p">,</span><span class="n">some_list</span><span class="p">)</span>
</span><span class='line'>            <span class="n">original_neighbors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>            <span class="n">original_neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">some_list</span><span class="p">[(</span><span class="n">position_in_original_list</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">list_size</span><span class="p">])</span>
</span><span class='line'>            <span class="n">original_neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">some_list</span><span class="p">[(</span><span class="n">position_in_original_list</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">list_size</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">new_neighbors</span> <span class="o">=</span> <span class="p">[]</span>
</span><span class='line'>            <span class="n">new_neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_neighbor_list</span><span class="p">[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">list_size</span><span class="p">])</span>
</span><span class='line'>            <span class="n">new_neighbors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_neighbor_list</span><span class="p">[(</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">list_size</span><span class="p">])</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">delta</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">new_neighbors</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">original_neighbors</span><span class="p">))</span>
</span><span class='line'>            <span class="c">#print &quot;for {} comparing: {} with {} = {}&quot;.format(team_member,original_neighbors,new_neighbors,delta)</span>
</span><span class='line'>
</span><span class='line'>            <span class="k">if</span> <span class="ow">not</span> <span class="n">delta</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span class='line'>               <span class="n">too_many_neighbors</span> <span class="o">=</span> <span class="bp">True</span>
</span><span class='line'>               <span class="k">break</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span> <span class="n">too_many_neighbors</span> <span class="o">==</span> <span class="bp">False</span><span class="p">:</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">new_neighbor_list</span>
</span><span class='line'>    <span class="k">else</span><span class="p">:</span>
</span><span class='line'>        <span class="k">print</span> <span class="s">&quot;No Matches&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">return</span> <span class="p">[]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># Usage      </span>
</span><span class='line'><span class="n">team</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;JT&#39;</span><span class="p">,</span><span class="s">&#39;FS&#39;</span><span class="p">,</span><span class="s">&#39;MC&#39;</span><span class="p">,</span><span class="s">&#39;MA&#39;</span><span class="p">,</span><span class="s">&#39;FD&#39;</span><span class="p">]</span>
</span><span class='line'><span class="n">new_seating</span> <span class="o">=</span> <span class="n">new_neighbors</span><span class="p">(</span><span class="n">team</span><span class="p">)</span>
</span><span class='line'><span class="k">print</span> <span class="n">new_seating</span>
</span><span class='line'><span class="c"># &gt;&gt; [&#39;MC&#39;, &#39;JT&#39;, &#39;MA&#39;, &#39;PS&#39;, &#39;FD&#39;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>To end with an quote to motivate:</p>

<blockquote><p>Everyday I&rsquo;m shufflin&#8217; &mdash; LMFAO</p></blockquote>

<iframe width="100%" height="400" src="http://www.youtube.com/embed/6RKwyKNEWRY" frameborder="0" allowfullscreen></iframe>


<p>(you can play that music as you are shuffling&#8217; seats)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/15/introducing-pivotal-tools/">Introducing Pivotal_tools</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-15T08:56:00-04:00" pubdate data-updated="true">Aug 15<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p>At ZEFR we are using Pivotal Tracker to help us with our Agile workflow.  Its a great tool, but we created a couple of command-line utilities that help us with our process.  We have found these to be real time-savers and helped up tighten up our process.</p>

<p>We have collected these utils into a python package <a href="https://github.com/jtushman/pivotal_tools">pivotal_tools</a>.  The 4 most useful utilities for us are:</p>

<ul>
<li><code>pivotal_tools scrum</code> : helps facilitate and visualize our daily scrum meetings</li>
<li><code>pivotal_tools planning</code>: (aka <code>pivotal_tools poker</code>) : helps facilitate our weekly estimation sessions</li>
<li><code>pivotal_tools changelog</code>: generates a changelog for all of delivered stories</li>
<li><code>pivotal_tools create (bug|feature|chore)</code>: creates an a story</li>
</ul>


<p>To install:</p>

<figure class='code'><figcaption><span>Install </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>pip install pivotal_tools
</span></code></pre></td></tr></table></div></figure>


<p>If you are a screencast person &mdash; have a watch (5min), alternatively there are screenshots and descriptions below the fold:</p>

<iframe width="100%" height="400" src="//www.youtube.com/embed/Pzsxssc30uE" frameborder="0" allowfullscreen></iframe>


<hr />

<h2>Sample Project</h2>

<p>Lets say you have project like the following:</p>

<p><img class="center" src="/images/pivotal_tracker.png"></p>

<h2><code>pivotal_tools show_stories</code></h2>

<p>Lists the top 20 stories.  Useful if you are looking for what story to pick up next</p>

<p><img class="center" src="/images/show_stories.png"></p>

<h2><code>pivotal_tools poker</code></h2>

<p>also can be run with <code>pivotal_tools planning</code>.  Iterates over your unestimated features, giving you a minimalist view of the feature.  Prompting the team for an estimate.</p>

<p><img class="center" src="/images/poker.png" title="pivotal tracker" alt="pivotal tracker"></p>

<h2><code>pivotal_tools scrum</code></h2>

<p>We use this tool for our daily scrum.  Simply shows what each member is working on.</p>

<p><img class="center" src="/images/scrum.png"></p>

<h2><code>pivotal_tools changelog</code></h2>

<p>During the release process, we use this to generate a change log that keeps our business owners in the loop.  We also use this during our scrum, to see what has been delivered in the current iteration.</p>

<p><img class="center" src="/images/changelog.png"></p>

<h2>Feedback</h2>

<p>Hopefully this will be a useful utility for others.  Feel free to fork and comment.  The repo is on github <a href="https://github.com/jtushman/pivotal_tools">(here)</a></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section xmlns="http://www.w3.org/1999/html">
  <h1>About Me</h1>
    <ul>
        <li>I&#8217;m <a href="http://tushman.com" target="_blank">Jonathan Tushman</a>        </li>
        <li>I am a pragmatic technologist (<a href="http://tushman.com/resume" target="_blank">bio</a>)        </li>
        <li>I work at <a href="http://www.zefr.com" target="_blank">ZEFR</a>                            </li>
        <li>&#8230; and we&#8217;re <a href="http://careers.stackoverflow.com/company/zefr">hiring</a></li>
        <li>I love to build <a href="http://tushman.com/resume" target="_blank">things</a>              </li>
        <li>I like <a href="http://tushman.com/music" target="_blank">music</a> and playing board games </li>
        <li>I read the <a href="http://www.economist.com" target="_blank">Economist</a>                 </li>
        <li>Follow me if you like <a href="http://www.twitter.com/tushman" target="_blank">@tushman</a> </li>
    </ul>


</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/09/15/pycon-proposal-pragmatic-behavior-driven-development/">PyCon Proposal - Pragmatic Behavior Driven Development</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/08/15/describing-descriptors-descriptively/">Describing Descriptors Descriptively</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/23/explaining-bouncer-and-method-decorators/">Explaining Bouncer and Method_decorators</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/07/22/boston-python-%7C-monarch-and-bouncer-notes/">Boston Python | Monarch and Bouncer Notes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2014/05/02/module-properties/">Module Properties | the Proxy Pattern</a>
      </li>
    
  </ul>
</section>
<section>
    <h1>Twitter</h1>
    <a class="twitter-timeline" href="https://twitter.com/tushman" data-widget-id="338399291280326658">Tweets by @tushman</a>
    <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+"://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
</section>




  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 - Jonathan Tushman -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jtushmanblog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
